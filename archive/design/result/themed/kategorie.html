<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShopZebra - Obst & Gem&uuml;se</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  [data-theme="dark"] {
    --body-bg: #0a0a0e;
    --screen-bg: #121216;
    --screen-gradient: none;
    --surface: rgba(255,255,255,0.04);
    --surface-border: rgba(255,255,255,0.06);
    --surface-selected: rgba(78,157,166,0.06);
    --surface-selected-border: rgba(78,157,166,1);
    --surface-selected-shadow: 0 0 15px rgba(78,157,166,0.25), 0 0 30px rgba(78,157,166,0.1);
    --teal: #4E9DA6;
    --green: #6BBF6B;
    --text-primary: #ffffff;
    --text-secondary: rgba(255,255,255,0.5);
    --text-dim: rgba(255,255,255,0.35);
    --header-title-color: #6BBF6B;
    --header-title-shadow: 0 0 20px rgba(107,191,107,0.3);
    --search-bg: rgba(255,255,255,0.05);
    --search-border: rgba(255,255,255,0.08);
    --stepper-bg: rgba(0,0,0,0.6);
    --stepper-border: rgba(78,157,166,0.3);
    --bottom-bar-bg: rgba(18,18,22,0.9);
    --summary-bg: rgba(18,18,22,0.92);
    --frame-shadow: 0 0 60px rgba(0,0,0,0.5), 0 0 120px rgba(78,157,166,0.05);
    --frame-border: 1px solid rgba(255,255,255,0.08);
    --tile-radius: 20px;
  }

  [data-theme="glass"] {
    --body-bg: #1a1a2e;
    --screen-bg: #0a0a12;
    --screen-gradient: radial-gradient(ellipse at 30% 70%, rgba(80, 160, 80, 0.3) 0%, transparent 60%),
                       radial-gradient(ellipse at 70% 30%, rgba(50, 120, 180, 0.25) 0%, transparent 60%),
                       radial-gradient(ellipse at 50% 90%, rgba(120, 50, 180, 0.15) 0%, transparent 60%);
    --surface: rgba(255,255,255,0.06);
    --surface-border: rgba(255,255,255,0.08);
    --surface-selected: rgba(78,157,166,0.1);
    --surface-selected-border: rgba(78,157,166,0.5);
    --surface-selected-shadow: 0 0 20px rgba(78,157,166,0.12);
    --teal: #4E9DA6;
    --green: #7BCF7B;
    --text-primary: rgba(255,255,255,0.9);
    --text-secondary: rgba(255,255,255,0.5);
    --text-dim: rgba(255,255,255,0.3);
    --header-title-color: #7BCF7B;
    --header-title-shadow: none;
    --search-bg: rgba(255,255,255,0.06);
    --search-border: rgba(255,255,255,0.1);
    --stepper-bg: rgba(255,255,255,0.08);
    --stepper-border: rgba(255,255,255,0.1);
    --bottom-bar-bg: rgba(10,10,18,0.8);
    --summary-bg: #0a0a12;
    --frame-shadow: 0 40px 80px rgba(0,0,0,0.6), 0 0 120px rgba(139,92,246,0.15), 0 0 80px rgba(236,72,153,0.1);
    --frame-border: 1px solid rgba(255,255,255,0.08);
    --tile-radius: 16px;
  }

  body {
    background: var(--body-bg);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    transition: background 0.4s ease;
  }

  .phone-frame {
    width: 390px;
    height: 844px;
    background: var(--screen-bg);
    border-radius: 44px;
    overflow: hidden;
    position: relative;
    border: var(--frame-border);
    box-shadow: var(--frame-shadow);
    transition: box-shadow 0.4s ease, border-color 0.4s ease;
  }

  .screen {
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 110px;
    scrollbar-width: none;
    background: var(--screen-bg);
    transition: background 0.4s ease;
  }
  .screen::-webkit-scrollbar { display: none; }

  [data-theme="glass"] .screen {
    background-color: #0a0a12;
    background-image: var(--screen-gradient);
    background-attachment: fixed;
  }

  /* Status Bar */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 28px 8px;
    position: sticky;
    top: 0;
    z-index: 50;
    background: var(--screen-bg);
    transition: background 0.4s ease;
  }
  [data-theme="glass"] .status-bar { background: var(--screen-bg); }
  .status-time {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    width: 54px;
    transition: color 0.4s ease;
  }
  .status-icons {
    display: flex;
    gap: 6px;
    align-items: center;
    width: 72px;
    justify-content: flex-end;
  }
  .status-icons svg {
    width: 18px;
    height: 18px;
    fill: var(--text-primary);
    transition: fill 0.4s ease;
  }

  /* Theme Toggle */
  .theme-toggle {
    width: 28px;
    height: 28px;
    border: none;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    padding: 0;
  }
  .theme-toggle:hover { background: rgba(255,255,255,0.12); }
  .theme-toggle svg { width: 16px; height: 16px; fill: rgba(255,255,255,0.5); transition: fill 0.2s; }

  /* Header */
  .header {
    padding: 8px 20px 16px;
  }
  .header-top {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 4px;
  }
  .back-btn {
    width: 36px;
    height: 36px;
    border-radius: 12px;
    border: 1.5px solid var(--surface-border);
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  .back-btn:hover { border-color: var(--teal); }
  .back-btn svg { width: 18px; height: 18px; fill: var(--text-secondary); }
  .header-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--header-title-color);
    text-shadow: var(--header-title-shadow);
    letter-spacing: -0.3px;
    transition: color 0.4s ease, text-shadow 0.4s ease;
  }
  .header-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    padding-left: 48px;
    transition: color 0.4s ease;
  }

  /* Selected Summary */
  .selected-summary {
    position: sticky;
    top: 44px;
    z-index: 40;
    background: transparent;
    padding: 10px 20px;
    display: none;
    align-items: center;
    gap: 10px;
    border-bottom: none;
  }
  .selected-summary.visible { display: flex; }
  .summary-emojis {
    display: flex;
    gap: 4px;
    flex: 1;
    overflow: hidden;
  }
  .summary-emoji-circle {
    width: 32px;
    height: 32px;
    min-width: 32px;
    border-radius: 50%;
    background: var(--surface);
    border: 1px solid var(--surface-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.3s ease;
  }
  .summary-count {
    font-size: 12px;
    color: var(--teal);
    font-weight: 600;
    white-space: nowrap;
    transition: color 0.4s ease;
  }
  [data-theme="glass"] .selected-summary {
    background: transparent;
  }
  [data-theme="glass"] .summary-emoji-circle {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(78,157,166,0.35);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 0 8px rgba(78,157,166,0.1);
  }

  /* Search */
  .search-container { padding: 0 20px 12px; }
  .search-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border-radius: 16px;
    background: var(--search-bg);
    border: 1.5px solid var(--search-border);
    transition: all 0.3s ease;
  }
  .search-bar:focus-within {
    border-color: var(--teal);
    background: rgba(78,157,166,0.05);
  }
  .search-bar svg { width: 18px; height: 18px; fill: var(--text-dim); flex-shrink: 0; }
  .search-bar input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text-primary);
    font-size: 15px;
    transition: color 0.4s ease;
  }
  .search-bar input::placeholder { color: var(--text-dim); }
  .search-clear {
    width: 20px; height: 20px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: none;
    display: none; align-items: center; justify-content: center;
    cursor: pointer; padding: 0;
  }
  .search-clear.visible { display: flex; }
  .search-clear svg { width: 12px; height: 12px; fill: var(--text-secondary); }
  [data-theme="glass"] .search-bar { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

  /* Product Grid */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    padding: 0 20px;
  }

  .product-tile {
    aspect-ratio: 1 / 1;
    border-radius: var(--tile-radius);
    background: var(--surface);
    border: 1.5px solid var(--surface-border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
  }
  .product-tile:active { transform: scale(0.95); }
  .product-tile.selected {
    border-color: var(--surface-selected-border);
    background: var(--surface-selected);
    box-shadow: var(--surface-selected-shadow);
  }
  [data-theme="glass"] .product-tile { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
  .product-emoji {
    font-size: 36px;
    line-height: 1;
    transition: transform 0.3s ease;
  }
  .product-tile.selected .product-emoji { transform: scale(1.1); }
  .product-name {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    text-align: center;
    line-height: 1.2;
    padding: 0 6px;
    transition: color 0.3s ease;
  }
  .product-tile.selected .product-name { color: var(--text-primary); }
  .product-unit {
    font-size: 9px;
    color: var(--text-dim);
    transition: color 0.3s ease;
  }

  /* Stepper */
  .stepper {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 0;
    background: var(--stepper-bg);
    border: 1px solid var(--stepper-border);
    border-radius: 14px;
    padding: 2px;
    margin-top: 4px;
    transition: all 0.3s ease;
  }
  .product-tile.selected .stepper { display: flex; }
  [data-theme="glass"] .stepper { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 20px; }
  .stepper-btn {
    width: 28px;
    height: 24px;
    border: none;
    background: none;
    color: var(--teal);
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: background 0.15s;
  }
  .stepper-btn:hover { background: rgba(78,157,166,0.15); }
  .stepper-qty {
    font-size: 13px;
    font-weight: 700;
    color: var(--teal);
    min-width: 36px;
    text-align: center;
    transition: color 0.4s ease;
  }

  /* Check badge */
  .check-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--teal);
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  .product-tile.selected .check-badge { display: flex; }
  .check-badge svg { width: 12px; height: 12px; fill: #fff; }

  /* No results */
  .no-results {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 20px;
    gap: 8px;
  }
  .no-results.visible { display: flex; }
  .no-results-emoji { font-size: 40px; }
  .no-results-text { font-size: 15px; color: var(--text-secondary); }

  /* Bottom Bar */
  .bottom-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 16px 20px;
    padding-bottom: 34px;
    background: var(--bottom-bar-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--surface-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 50;
    transition: background 0.4s ease;
  }
  .bottom-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .bottom-count {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    transition: color 0.4s ease;
  }
  .bottom-hint {
    font-size: 11px;
    color: var(--text-dim);
    transition: color 0.4s ease;
  }
  .done-btn {
    padding: 12px 32px;
    border-radius: 16px;
    border: none;
    background: var(--green);
    color: #0a0a0e;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  .done-btn:hover { filter: brightness(1.1); transform: scale(1.02); }
  .done-btn:active { transform: scale(0.98); }
</style>
</head>
<body>

<div class="phone-frame">
  <div class="screen" id="screen">

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-time">9:41</div>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>
      <div class="status-icons">
        <svg viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
        <svg viewBox="0 0 24 24"><path d="M2 22h20V2z M20 20H6.83L20 6.83V20z"/></svg>
        <svg viewBox="0 0 24 24"><rect x="2" y="6" width="18" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><rect x="4" y="8" width="12" height="8" rx="1"/><path d="M22 10v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </div>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <button class="back-btn" aria-label="Back">
          <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </button>
        <div class="header-title">Obst & Gem&uuml;se</div>
      </div>
      <div class="header-subtitle" id="subtitle">21 Produkte</div>
    </div>

    <!-- Selected Summary -->
    <div class="selected-summary" id="summaryBar">
      <div class="summary-emojis" id="summaryEmojis"></div>
      <div class="summary-count" id="summaryCount"></div>
    </div>

    <!-- Search -->
    <div class="search-container">
      <div class="search-bar">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <input type="text" id="searchInput" placeholder="Produkt suchen..." oninput="handleSearch()">
        <button class="search-clear" id="searchClear" onclick="clearSearch()">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
    </div>

    <!-- Product Grid -->
    <div class="product-grid" id="productGrid"></div>

    <!-- No Results -->
    <div class="no-results" id="noResults">
      <div class="no-results-emoji">üîç</div>
      <div class="no-results-text">Kein Produkt gefunden</div>
    </div>

  </div>

  <!-- Bottom Bar -->
  <div class="bottom-bar">
    <div class="bottom-info">
      <div class="bottom-count" id="bottomCount">0 ausgew&auml;hlt</div>
      <div class="bottom-hint">aus dieser Kategorie</div>
    </div>
    <button class="done-btn" onclick="finish()">Fertig</button>
  </div>
</div>

<script>
const ALL_PRODUCTS = [
  { id: 'ananas', emoji: '\u{1F34D}', name: 'Ananas', unit: 'St' },
  { id: 'aepfel', emoji: '\u{1F34E}', name: '\u00C4pfel', unit: 'kg' },
  { id: 'avocado', emoji: '\u{1F951}', name: 'Avocado', unit: 'St' },
  { id: 'bananen', emoji: '\u{1F34C}', name: 'Bananen', unit: 'St' },
  { id: 'blaubeeren', emoji: '\u{1FAD0}', name: 'Blaubeeren', unit: 'Schale' },
  { id: 'brokkoli', emoji: '\u{1F966}', name: 'Brokkoli', unit: 'St' },
  { id: 'champignons', emoji: '\u{1F344}', name: 'Champignons', unit: '200g' },
  { id: 'erdbeeren', emoji: '\u{1F353}', name: 'Erdbeeren', unit: 'Schale' },
  { id: 'gurke', emoji: '\u{1F952}', name: 'Gurke', unit: 'St' },
  { id: 'ingwer', emoji: '\u{1FADA}', name: 'Ingwer', unit: 'St' },
  { id: 'kartoffeln', emoji: '\u{1F954}', name: 'Kartoffeln', unit: 'kg' },
  { id: 'knoblauch', emoji: '\u{1F9C4}', name: 'Knoblauch', unit: 'Knolle' },
  { id: 'moehren', emoji: '\u{1F955}', name: 'M\u00F6hren', unit: 'kg' },
  { id: 'paprika', emoji: '\u{1FAD1}', name: 'Paprika', unit: 'St' },
  { id: 'salat', emoji: '\u{1F96C}', name: 'Salat', unit: 'Kopf' },
  { id: 'spinat', emoji: '\u{1F33F}', name: 'Spinat', unit: 'Beutel' },
  { id: 'tomaten', emoji: '\u{1F345}', name: 'Tomaten', unit: 'kg' },
  { id: 'trauben', emoji: '\u{1F347}', name: 'Trauben', unit: 'kg' },
  { id: 'zitronen', emoji: '\u{1F34B}', name: 'Zitronen', unit: 'St' },
  { id: 'zucchini', emoji: '\u{1F952}', name: 'Zucchini', unit: 'St' },
  { id: 'zwiebeln', emoji: '\u{1F9C5}', name: 'Zwiebeln', unit: 'Netz' }
];

const DEFAULT_ITEMS = [
  { id: 'aepfel', emoji: '\u{1F34E}', name: '\u00C4pfel', qty: 2, unit: 'kg', cat: 'obst-gemuese' },
  { id: 'bananen', emoji: '\u{1F34C}', name: 'Bananen', qty: 6, unit: 'St', cat: 'obst-gemuese' },
  { id: 'tomaten', emoji: '\u{1F345}', name: 'Tomaten', qty: 1, unit: 'kg', cat: 'obst-gemuese' },
  { id: 'kartoffeln', emoji: '\u{1F954}', name: 'Kartoffeln', qty: 2, unit: 'kg', cat: 'obst-gemuese' },
  { id: 'gurke', emoji: '\u{1F952}', name: 'Gurke', qty: 2, unit: 'St', cat: 'obst-gemuese' },
  { id: 'paprika', emoji: '\u{1FAD1}', name: 'Paprika', qty: 3, unit: 'St', cat: 'obst-gemuese' },
  { id: 'zwiebeln', emoji: '\u{1F9C5}', name: 'Zwiebeln', qty: 1, unit: 'Netz', cat: 'obst-gemuese' },
  { id: 'salat', emoji: '\u{1F96C}', name: 'Salat', qty: 1, unit: 'Kopf', cat: 'obst-gemuese' },
  { id: 'milch', emoji: '\u{1F95B}', name: 'Milch', qty: 2, unit: 'L', cat: 'milch-kaese' },
  { id: 'gouda', emoji: '\u{1F9C0}', name: 'Gouda', qty: 1, unit: 'Pck', cat: 'milch-kaese' },
  { id: 'jogurt', emoji: '\u{1F95B}', name: 'Joghurt', qty: 4, unit: 'St', cat: 'milch-kaese' },
  { id: 'butter', emoji: '\u{1F9C8}', name: 'Butter', qty: 1, unit: 'St', cat: 'milch-kaese' },
  { id: 'vollkornbrot', emoji: '\u{1F35E}', name: 'Vollkornbrot', qty: 1, unit: 'St', cat: 'brot-gebaeck' },
  { id: 'broetchen', emoji: '\u{1F950}', name: 'Br\u00F6tchen', qty: 6, unit: 'St', cat: 'brot-gebaeck' },
  { id: 'hackfleisch', emoji: '\u{1F969}', name: 'Hackfleisch', qty: 1, unit: '500g', cat: 'fleisch-fisch' },
  { id: 'haehnchen', emoji: '\u{1F357}', name: 'H\u00E4hnchenbrust', qty: 1, unit: '400g', cat: 'fleisch-fisch' },
  { id: 'lachs', emoji: '\u{1F41F}', name: 'Lachs', qty: 1, unit: '200g', cat: 'fleisch-fisch' },
  { id: 'nudeln', emoji: '\u{1F35D}', name: 'Nudeln', qty: 2, unit: 'Pck', cat: 'zutaten-gewuerze' },
  { id: 'reis', emoji: '\u{1F35A}', name: 'Reis', qty: 1, unit: 'Pck', cat: 'zutaten-gewuerze' },
  { id: 'olivenoel', emoji: '\u{1FAD2}', name: 'Oliven\u00F6l', qty: 1, unit: 'Fl', cat: 'zutaten-gewuerze' },
  { id: 'passierte-tomaten', emoji: '\u{1F96B}', name: 'Passierte Tomaten', qty: 2, unit: 'Pck', cat: 'zutaten-gewuerze' },
  { id: 'sojasauce', emoji: '\u{1F962}', name: 'Sojasauce', qty: 1, unit: 'Fl', cat: 'zutaten-gewuerze' }
];

const CATEGORY = 'obst-gemuese';
const STORAGE_KEY = 'shopzebra_items';

function loadItems() {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) {
    try { return JSON.parse(stored); } catch(e) { /* ignore */ }
  }
  const items = DEFAULT_ITEMS.map(i => ({...i}));
  saveItems(items);
  return items;
}

function saveItems(items) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
}

function getCategoryItems() {
  const items = loadItems();
  return items.filter(i => i.cat === CATEGORY);
}

function getSelectedQty(productId) {
  const items = loadItems();
  const found = items.find(i => i.id === productId);
  return found ? found.qty : 0;
}

function setProductQty(productId, qty) {
  const items = loadItems();
  const product = ALL_PRODUCTS.find(p => p.id === productId);
  if (!product) return;

  const idx = items.findIndex(i => i.id === productId);
  if (qty <= 0) {
    if (idx !== -1) items.splice(idx, 1);
  } else {
    if (idx !== -1) {
      items[idx].qty = qty;
    } else {
      items.push({
        id: product.id,
        emoji: product.emoji,
        name: product.name,
        qty: qty,
        unit: product.unit,
        cat: CATEGORY
      });
    }
  }
  saveItems(items);
}

function toggleProduct(productId) {
  const currentQty = getSelectedQty(productId);
  if (currentQty > 0) {
    setProductQty(productId, 0);
  } else {
    setProductQty(productId, 1);
  }
  renderGrid();
  renderSummaryBar();
  updateBottomBar();
}

function adjustQty(productId, delta, event) {
  event.stopPropagation();
  const currentQty = getSelectedQty(productId);
  const newQty = Math.max(0, currentQty + delta);
  setProductQty(productId, newQty);
  renderGrid();
  renderSummaryBar();
  updateBottomBar();
}

function renderGrid() {
  const grid = document.getElementById('productGrid');
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  const filtered = query
    ? ALL_PRODUCTS.filter(p => p.name.toLowerCase().includes(query))
    : ALL_PRODUCTS;

  document.getElementById('noResults').classList.toggle('visible', filtered.length === 0);

  grid.innerHTML = filtered.map(p => {
    const qty = getSelectedQty(p.id);
    const selected = qty > 0;
    return `
      <div class="product-tile ${selected ? 'selected' : ''}" onclick="toggleProduct('${p.id}')">
        <div class="check-badge">
          <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
        <div class="product-emoji">${p.emoji}</div>
        <div class="product-name">${p.name}</div>
        <div class="product-unit">${p.unit}</div>
        ${selected ? `
          <div class="stepper" style="display:flex">
            <button class="stepper-btn" onclick="adjustQty('${p.id}', -1, event)">&minus;</button>
            <div class="stepper-qty">${qty} ${p.unit}</div>
            <button class="stepper-btn" onclick="adjustQty('${p.id}', 1, event)">+</button>
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

function renderSummaryBar() {
  const catItems = getCategoryItems();
  const bar = document.getElementById('summaryBar');
  const emojisContainer = document.getElementById('summaryEmojis');
  const countEl = document.getElementById('summaryCount');

  if (catItems.length === 0) {
    bar.classList.remove('visible');
    return;
  }

  bar.classList.add('visible');
  emojisContainer.innerHTML = catItems.map(i =>
    `<div class="summary-emoji-circle">${i.emoji}</div>`
  ).join('');
  countEl.textContent = `${catItems.length} von ${ALL_PRODUCTS.length}`;
}

function updateBottomBar() {
  const catItems = getCategoryItems();
  document.getElementById('bottomCount').textContent = `${catItems.length} ausgew\u00E4hlt`;
}

function handleSearch() {
  const query = document.getElementById('searchInput').value;
  document.getElementById('searchClear').classList.toggle('visible', query.length > 0);
  renderGrid();
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  document.getElementById('searchClear').classList.remove('visible');
  renderGrid();
}

function finish() {
  window.location.href = 'index.html';
}

/* Theme */
function getTheme() {
  return localStorage.getItem('shopzebra_theme') || 'dark';
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('shopzebra_theme', theme);
  const btn = document.getElementById('themeToggle');
  if (theme === 'dark') {
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>';
  } else {
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>';
  }
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  applyTheme(current === 'dark' ? 'glass' : 'dark');
}

/* Init */
applyTheme(getTheme());
renderGrid();
renderSummaryBar();
updateBottomBar();
</script>

</body>
</html>
